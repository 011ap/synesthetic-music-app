<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Synesthetic - Digital Consciousness Engine</title>
    <meta name="description" content="Revolutionary music emotion analysis with synesthetic experiences. Feel music, share souls.">
    
    <!-- Add our custom styles -->
    <link rel="stylesheet" href="auth-styles.css">
    
    <style>
        /* === CSS VARIABLES FOR EMOTIONAL THEMES === */
        :root {
            /* Dark theme - matching your screenshot */
            --bg-dark: #0f0f14;
            --bg-darker: #08080c;
            --glass-overlay: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.06);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.5);
            
            /* Synesthetic Color Palette - Vibrant for contrast */
            --synesthetic-red: #ff006e;
            --synesthetic-blue: #0096ff;
            --synesthetic-teal: #00f5ff;
            --synesthetic-green: #00ff88;
            --synesthetic-purple: #ff00ff;
            --synesthetic-gold: #ffd700;
            --synesthetic-orange: #ff6b00;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-xxl: 3rem;
            
            /* Transitions */
            --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-quick: all 0.2s ease;
            
            /* Glass Effect */
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 40px rgba(0, 245, 255, 0.5);
            
            /* Border Radius */
            --radius-sm: 0.5rem;
            --radius-md: 1rem;
            --radius-lg: 1.5rem;
            --radius-full: 9999px;
        }

        /* === RESET AND BASE STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            touch-action: manipulation;
        }

        /* === ANIMATED BACKGROUND - SUBTLE FOR DARK THEME === */
        .emotional-background {
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            z-index: -1;
            opacity: 0.3;
            background: radial-gradient(circle at 20% 50%, var(--synesthetic-red), transparent 40%),
                        radial-gradient(circle at 80% 80%, var(--synesthetic-blue), transparent 40%),
                        radial-gradient(circle at 40% 20%, var(--synesthetic-teal), transparent 40%);
            filter: blur(120px);
            animation: emotionalShift 20s ease-in-out infinite;
            transform: scale(1.5);
        }

        /* TV Mode - Extra bright for living rooms */
        body.tv-mode .emotional-background {
            opacity: 0.8;
            filter: blur(80px) saturate(2);
            transform: scale(2);
        }

        @keyframes emotionalShift {
            0%, 100% { transform: scale(1.5) rotate(0deg); }
            33% { transform: scale(2) rotate(120deg); }
            66% { transform: scale(1.3) rotate(240deg); }
        }

        /* === CONTAINER === */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-md);
            position: relative;
            z-index: 1;
        }

        /* === HEADER - ELEGANT DARK === */
        .header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-xxl) 0 var(--spacing-xl);
            position: relative;
        }

        .logo {
            font-size: clamp(2.5rem, 8vw, 4rem);
            font-weight: 200;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(135deg, var(--synesthetic-teal), var(--synesthetic-blue));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: logoShift 15s ease-in-out infinite;
        }

        @keyframes logoShift {
            0%, 100% { filter: hue-rotate(0deg) brightness(1); }
            50% { filter: hue-rotate(20deg) brightness(1.1); }
        }

        .tagline {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            color: var(--text-tertiary);
            font-weight: 300;
            letter-spacing: 0.02em;
        }

        /* === STATUS INDICATOR === */
        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-xs) var(--spacing-lg);
            background: var(--glass-overlay);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-full);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--synesthetic-red);
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px var(--synesthetic-red);
        }

        .status-indicator.active {
            background: var(--synesthetic-green);
            box-shadow: 0 0 15px var(--synesthetic-green);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        /* === PRIMARY CONTROLS - MINIMAL ICON STYLE === */
        .primary-controls {
            margin-bottom: var(--spacing-xl);
        }

        .control-grid {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .icon-button {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-lg);
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            transition: all var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .icon-button:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--synesthetic-teal);
            box-shadow: 0 8px 25px rgba(0, 245, 255, 0.2);
        }

        .icon-button.active {
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.15), rgba(0, 150, 255, 0.15));
            border-color: var(--synesthetic-teal);
            box-shadow: 0 0 25px rgba(0, 245, 255, 0.3);
        }

        .icon-button .icon {
            font-size: 1.8rem;
            transition: transform var(--transition-quick);
        }

        .icon-button:hover .icon {
            transform: scale(1.1);
        }

        .icon-button .label {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Tooltip */
        .icon-button::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all var(--transition-quick);
        }

        .icon-button:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        /* === AUDIO PLAYER - DARK ELEGANT === */
        .audio-player {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            display: none;
            position: relative;
        }

        .audio-player.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .player-info {
            flex: 1;
        }

        .track-name {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .close-player {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: var(--radius-full);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-quick);
            color: var(--text-tertiary);
            font-size: 1rem;
        }

        .close-player:hover {
            background: rgba(255, 107, 107, 0.2);
            color: var(--text-primary);
        }

        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-full);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-quick);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--synesthetic-teal);
            transform: scale(1.1);
        }

        .control-btn.play-pause {
            width: 44px;
            height: 44px;
            font-size: 1.1rem;
            background: rgba(0, 245, 255, 0.08);
        }

        .control-btn.loop.active {
            color: var(--synesthetic-teal);
            background: rgba(0, 245, 255, 0.1);
        }

        .progress-container {
            position: relative;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-sm);
            overflow: hidden;
            cursor: pointer;
            margin-bottom: var(--spacing-xs);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--synesthetic-teal), var(--synesthetic-blue));
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 8px var(--synesthetic-teal);
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* === EMOTIONAL INTELLIGENCE DISPLAY === */
        .emotional-intelligence {
            margin-bottom: var(--spacing-xxl);
        }

        .section-title {
            font-size: clamp(1.3rem, 3.5vw, 1.6rem);
            font-weight: 200;
            margin-bottom: var(--spacing-xl);
            text-align: center;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
        }

        /* === EMOTION VISUALIZATION - DARK ELEGANT === */
        .emotion-visualization {
            position: relative;
            height: 200px;
            background: rgba(255, 255, 255, 0.01);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
            border: 1px solid rgba(255, 255, 255, 0.04);
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .emotion-particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--synesthetic-teal);
            border-radius: 50%;
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
            box-shadow: 0 0 6px currentColor;
        }

        @keyframes float {
            0%, 100% { 
                transform: translate(0, 0) scale(1); 
                opacity: 0;
            }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            50% { 
                transform: translate(100px, -100px) scale(1.5);
                filter: blur(1px);
            }
        }

        /* === CONSCIOUSNESS GRID === */
        .consciousness-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
        }

        .consciousness-layer {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: all var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .consciousness-layer:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glass);
            border-color: rgba(0, 245, 255, 0.2);
        }

        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .layer-title {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .layer-confidence {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            background: rgba(0, 245, 255, 0.08);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
        }

        .emotion-name {
            font-size: 1.3rem;
            font-weight: 300;
            margin-bottom: var(--spacing-xs);
            background: linear-gradient(135deg, var(--synesthetic-teal), var(--synesthetic-blue));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .emotion-description {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            line-height: 1.4;
        }

        /* === UPLOAD AREA === */
        .upload-section {
            margin-bottom: var(--spacing-xxl);
        }

        .upload-area {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            border: 2px dashed rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            transition: all var(--transition-smooth);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: rgba(0, 245, 255, 0.3);
            background: rgba(0, 245, 255, 0.02);
        }

        .upload-area.dragover {
            border-color: var(--synesthetic-blue);
            background: rgba(0, 150, 255, 0.05);
            transform: scale(1.01);
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.7;
        }

        .upload-text {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .upload-subtext {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        #fileInput {
            display: none;
        }

        /* === TV MODE BUTTON === */
        .tv-mode-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
            padding: var(--spacing-xs) var(--spacing-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-smooth);
            z-index: 100;
            font-size: 0.85rem;
        }

        .tv-mode-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .tv-mode-btn.active {
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.2), rgba(0, 150, 255, 0.2));
            color: var(--synesthetic-teal);
            border-color: var(--synesthetic-teal);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }

        /* === MOBILE OPTIMIZATIONS === */
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-sm);
            }
            
            .control-grid {
                gap: var(--spacing-md);
            }
            
            .icon-button {
                width: 70px;
                height: 70px;
            }
            
            .icon-button .icon {
                font-size: 1.5rem;
            }
            
            .icon-button .label {
                font-size: 0.65rem;
            }
            
            .consciousness-grid {
                grid-template-columns: 1fr;
            }
            
            .emotion-visualization {
                height: 150px;
            }
            
            .tv-mode-btn {
                bottom: 1rem;
                right: 1rem;
                font-size: 0.8rem;
                padding: var(--spacing-xs) var(--spacing-sm);
            }
            
            /* Mobile-friendly auth button */
            .auth-button {
                position: fixed;
                top: 1rem;
                right: 1rem;
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
        }

        /* === HIDDEN UTILITY === */
        .hidden {
            display: none !important;
        }

        /* === LOADING SPINNER === */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--synesthetic-teal);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="emotional-background"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="logo">Synesthetic</h1>
            <p class="tagline">Digital Consciousness Through Musical Emotion</p>
        </header>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Ready to Feel Music</span>
        </div>

        <!-- Primary Controls - Minimal Icon Style -->
        <section class="primary-controls">
            <div class="control-grid">
                <button class="icon-button" id="micButton" data-tooltip="Analyze room audio in real-time">
                    <span class="icon">🎤</span>
                    <span class="label">Live</span>
                </button>
                
                <button class="icon-button" id="uploadButton" data-tooltip="Upload and analyze your music files">
                    <span class="icon">📁</span>
                    <span class="label">Upload</span>
                </button>
                
                <button class="icon-button" id="spotifyButton" data-tooltip="Connect to Spotify (Coming Soon)">
                    <span class="icon">🎵</span>
                    <span class="label">Spotify</span>
                </button>
            </div>
        </section>

        <!-- Upload Area -->
        <section class="upload-section hidden" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">🎵</div>
                <div class="upload-text">Drop your music file here or click to browse</div>
                <div class="upload-subtext">Supported formats: MP3, WAV, M4A</div>
                <input type="file" id="fileInput" accept="audio/*">
            </div>
        </section>

        <!-- Enhanced Audio Player -->
        <div class="audio-player" id="audioPlayer">
            <div class="player-header">
                <div class="player-info">
                    <div class="track-name" id="trackName">No track loaded</div>
                </div>
                <button class="close-player" id="closePlayer">×</button>
            </div>
            <div class="player-controls">
                <button class="control-btn" id="prevBtn">⏮</button>
                <button class="control-btn play-pause" id="playPauseBtn">▶</button>
                <button class="control-btn" id="nextBtn">⏭</button>
                <button class="control-btn loop" id="loopBtn">🔁</button>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>
        </div>

        <!-- Emotional Intelligence Display -->
        <section class="emotional-intelligence">
            <h2 class="section-title">Emotional Consciousness Analysis</h2>
            
            <!-- Emotion Visualization -->
            <div class="emotion-visualization">
                <div class="emotion-particles" id="emotionParticles"></div>
            </div>
            
            <div class="consciousness-grid">
                <!-- Primary Emotion -->
                <div class="consciousness-layer">
                    <div class="layer-header">
                        <h3 class="layer-title">Primary Emotion</h3>
                        <span class="layer-confidence" id="primaryConfidence">0%</span>
                    </div>
                    <div class="emotion-display">
                        <div class="emotion-name" id="primaryEmotion">Waiting...</div>
                        <div class="emotion-description" id="emotionDescription">Play music to begin analysis</div>
                    </div>
                </div>
                
                <!-- Emotional Depth -->
                <div class="consciousness-layer">
                    <div class="layer-header">
                        <h3 class="layer-title">Emotional Depth</h3>
                        <span class="layer-confidence">Live</span>
                    </div>
                    <div class="depth-display">
                        <div id="emotionalDepth">Analyzing complexity...</div>
                    </div>
                </div>
                
                <!-- Synesthetic Mapping -->
                <div class="consciousness-layer">
                    <div class="layer-header">
                        <h3 class="layer-title">Synesthetic Translation</h3>
                        <span class="layer-confidence">Active</span>
                    </div>
                    <div class="synesthetic-display" id="synestheticDisplay">
                        <div>Color resonance mapping...</div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- TV Mode Button -->
    <button class="tv-mode-btn" id="tvModeBtn">📺 TV Mode</button>

    <!-- Audio element -->
    <audio id="audioElement" crossorigin="anonymous"></audio>

    <!-- Load our scripts in correct order -->
    <script src="auth.js"></script>
    <script src="login.js"></script>
    <script src="premium.js"></script>
    <script src="lights.js"></script>
    <script src="app.js"></script>
    
    <script>
        // === EMOTIONAL INTELLIGENCE ENGINE ===
        class EmotionalIntelligenceEngine {
            constructor() {
                this.audioContext = null;
                this.analyser = null;
                this.source = null;
                this.isAnalyzing = false;
                this.currentEmotion = null;
                this.emotionalHistory = [];
                this.emotionMap = this.initializeEmotionMap();
                this.isLooping = false;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.createParticles();
                this.loadTVMode();
            }

            initializeEmotionMap() {
                return {
                    joy: {
                        name: 'Euphoric Joy',
                        colors: ['#FFD700', '#FFA500', '#FF69B4'],
                        colorsVibrant: ['#FFFF00', '#FF6B00', '#FF00FF'],
                        characteristics: {
                            tempo: [120, 180],
                            frequency: [2000, 8000],
                            amplitude: [0.7, 1.0],
                            harmonicity: [0.8, 1.0]
                        },
                        description: 'Uplifting energy with bright harmonic resonance'
                    },
                    sadness: {
                        name: 'Melancholic Depth',
                        colors: ['#4169E1', '#483D8B', '#191970'],
                        colorsVibrant: ['#0096FF', '#0048FF', '#000080'],
                        characteristics: {
                            tempo: [40, 80],
                            frequency: [200, 1000],
                            amplitude: [0.2, 0.5],
                            harmonicity: [0.3, 0.6]
                        },
                        description: 'Deep introspective waves with slow-moving patterns'
                    },
                    energy: {
                        name: 'Dynamic Power',
                        colors: ['#FF0000', '#FF4500', '#DC143C'],
                        colorsVibrant: ['#FF0040', '#FF6B00', '#FF006E'],
                        characteristics: {
                            tempo: [140, 200],
                            frequency: [100, 500],
                            amplitude: [0.8, 1.0],
                            harmonicity: [0.5, 0.8]
                        },
                        description: 'Intense rhythmic pulses with driving force'
                    },
                    calm: {
                        name: 'Serene Peace',
                        colors: ['#4ECDC4', '#45B7D1', '#96CEB4'],
                        colorsVibrant: ['#00F5FF', '#00C8FF', '#00FF88'],
                        characteristics: {
                            tempo: [60, 100],
                            frequency: [500, 2000],
                            amplitude: [0.3, 0.6],
                            harmonicity: [0.7, 0.9]
                        },
                        description: 'Gentle flowing movements in harmonic balance'
                    },
                    mystery: {
                        name: 'Enigmatic Wonder',
                        colors: ['#9370DB', '#8A2BE2', '#4B0082'],
                        colorsVibrant: ['#FF00FF', '#C800FF', '#8000FF'],
                        characteristics: {
                            tempo: [80, 120],
                            frequency: [300, 3000],
                            amplitude: [0.4, 0.7],
                            harmonicity: [0.4, 0.7]
                        },
                        description: 'Complex layered patterns with unpredictable shifts'
                    }
                };
            }

            setupEventListeners() {
                // Microphone button
                document.getElementById('micButton').addEventListener('click', () => this.toggleMicrophone());
                
                // Upload button
                document.getElementById('uploadButton').addEventListener('click', () => {
                    document.getElementById('uploadSection').classList.toggle('hidden');
                });
                
                // File input
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileUpload(e));
                
                // Upload area drag and drop
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.addEventListener('click', () => document.getElementById('fileInput').click());
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        this.processAudioFile(e.dataTransfer.files[0]);
                    }
                });
                
                // Audio player controls
                document.getElementById('playPauseBtn').addEventListener('click', () => this.togglePlayPause());
                document.getElementById('progressBar').addEventListener('click', (e) => this.seekTo(e));
                document.getElementById('loopBtn').addEventListener('click', () => this.toggleLoop());
                document.getElementById('closePlayer').addEventListener('click', () => this.closePlayer());
                
                // TV Mode button
                document.getElementById('tvModeBtn').addEventListener('click', () => this.toggleTVMode());
                
                // Time update for audio
                const audioElement = document.getElementById('audioElement');
                audioElement.addEventListener('timeupdate', () => this.updateTimeDisplay());
                audioElement.addEventListener('ended', () => {
                    if (this.isLooping) {
                        audioElement.currentTime = 0;
                        audioElement.play();
                    } else {
                        document.getElementById('playPauseBtn').textContent = '▶';
                    }
                });
            }

            async toggleMicrophone() {
            const button = document.getElementById('micButton');
    
            if (this.isAnalyzing && this.source && this.source.mediaStream) {
                // Properly stop the microphone
                this.stopAnalysis();
                button.classList.remove('active');
                this.source = null; // Clear the source
                return;
            }
    
            // Check premium limits
            if (window.premiumManager && !await window.premiumManager.analyzeSongWithLimits()) {
                return;
            }
    
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                await this.startMicrophoneAnalysis(stream);
                button.classList.add('active');
            } catch (error) {
                console.error('Microphone access error:', error);
                this.updateStatus('Microphone error: ' + (error && error.message ? error.message : error), false);
            }
        }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    // Check premium limits
                    if (window.premiumManager && !await window.premiumManager.analyzeSongWithLimits()) {
                        return;
                    }
                    this.processAudioFile(file);
                }
            }

            processAudioFile(file) {
                const audioElement = document.getElementById('audioElement');
                const audioPlayer = document.getElementById('audioPlayer');
                const trackName = document.getElementById('trackName');
                
                // Update UI
                trackName.textContent = file.name;
                audioPlayer.classList.add('active');
                document.getElementById('uploadSection').classList.add('hidden');
                
                // Create object URL and load audio
                const url = URL.createObjectURL(file);
                audioElement.src = url;
                
                // Start analysis when audio loads
                audioElement.addEventListener('loadedmetadata', () => {
                    this.startFileAnalysis(audioElement);
                    document.getElementById('totalTime').textContent = this.formatTime(audioElement.duration);
                }, { once: true });
            }

            async startMicrophoneAnalysis(stream) {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Create audio nodes
                this.source = this.audioContext.createMediaStreamSource(stream);
                this.mediaStream = stream; // Store reference to the stream for stopping later
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 2048;
                
                // Connect nodes
                this.source.connect(this.analyser);
                
                // Start analysis
                this.isAnalyzing = true;
                this.updateStatus('Analyzing live audio...', true);
                this.analyzeAudio();
            }

            startFileAnalysis(audioElement) {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Create audio nodes if not already created
                if (!this.source || !this.source.mediaElement) {
                    this.source = this.audioContext.createMediaElementSource(audioElement);
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 2048;
                    
                    // Connect nodes
                    this.source.connect(this.analyser);
                    this.source.connect(this.audioContext.destination);
                }
                
                // Start analysis
                this.isAnalyzing = true;
                this.updateStatus('Analyzing music file...', true);
                this.analyzeAudio();
            }

            analyzeAudio() {
                if (!this.isAnalyzing) return;
                
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                this.analyser.getByteFrequencyData(dataArray);
                
                // Extract audio features
                const features = this.extractAudioFeatures(dataArray);
                
                // Detect emotion based on features
                const emotion = this.detectEmotion(features);
                
                // Update UI with emotion
                this.updateEmotionalDisplay(emotion, features);
                
                // Continue analysis
                requestAnimationFrame(() => this.analyzeAudio());
            }

            extractAudioFeatures(dataArray) {
                // Calculate various audio features
                const sum = dataArray.reduce((a, b) => a + b, 0);
                const average = sum / dataArray.length;
                
                // Frequency bands
                const bass = this.getFrequencyBandAverage(dataArray, 0, 10);
                const lowMid = this.getFrequencyBandAverage(dataArray, 10, 50);
                const mid = this.getFrequencyBandAverage(dataArray, 50, 100);
                const highMid = this.getFrequencyBandAverage(dataArray, 100, 200);
                const treble = this.getFrequencyBandAverage(dataArray, 200, dataArray.length);
                
                // Spectral centroid (brightness)
                let weightedSum = 0;
                let magnitudeSum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    weightedSum += i * dataArray[i];
                    magnitudeSum += dataArray[i];
                }
                const spectralCentroid = magnitudeSum > 0 ? weightedSum / magnitudeSum : 0;
                
                // Energy
                const energy = average / 255;
                
                // Tempo estimation (simplified)
                const tempo = this.estimateTempo(dataArray);
                
                return {
                    bass,
                    lowMid,
                    mid,
                    highMid,
                    treble,
                    spectralCentroid,
                    energy,
                    tempo,
                    timestamp: Date.now()
                };
            }

            getFrequencyBandAverage(dataArray, start, end) {
                let sum = 0;
                for (let i = start; i < end && i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                return sum / (end - start);
            }

            estimateTempo(dataArray) {
                // Simplified tempo estimation based on energy peaks
                const energy = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                return 60 + (energy / 255) * 140; // Maps to 60-200 BPM range
            }

            detectEmotion(features) {
                let bestMatch = null;
                let bestScore = -1;
                
                // Compare features against emotion profiles
                for (const [emotionKey, emotion] of Object.entries(this.emotionMap)) {
                    let score = 0;
                    
                    // Tempo matching
                    if (features.tempo >= emotion.characteristics.tempo[0] && 
                        features.tempo <= emotion.characteristics.tempo[1]) {
                        score += 0.3;
                    }
                    
                    // Frequency matching (using spectral centroid as proxy)
                    const normalizedCentroid = (features.spectralCentroid / 1024) * 8000;
                    if (normalizedCentroid >= emotion.characteristics.frequency[0] && 
                        normalizedCentroid <= emotion.characteristics.frequency[1]) {
                        score += 0.3;
                    }
                    
                    // Energy/amplitude matching
                    if (features.energy >= emotion.characteristics.amplitude[0] && 
                        features.energy <= emotion.characteristics.amplitude[1]) {
                        score += 0.2;
                    }
                    
                    // Harmonicity (using frequency band ratios as proxy)
                    const harmonicity = (features.mid + features.highMid) / (features.bass + features.lowMid + 0.1);
                    const normalizedHarmonicity = Math.min(harmonicity / 2, 1);
                    if (normalizedHarmonicity >= emotion.characteristics.harmonicity[0] && 
                        normalizedHarmonicity <= emotion.characteristics.harmonicity[1]) {
                        score += 0.2;
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = { ...emotion, key: emotionKey, confidence: Math.round(score * 100) };
                    }
                }
                
                this.currentEmotion = bestMatch; // Store current emotion
                return bestMatch;
            }

            updateEmotionalDisplay(emotion, features) {
                if (!emotion) return;
                
                // Update primary emotion
                document.getElementById('primaryEmotion').textContent = emotion.name;
                document.getElementById('emotionDescription').textContent = emotion.description;
                document.getElementById('primaryConfidence').textContent = emotion.confidence + '%';
                
                // Update emotional depth
                const depth = this.calculateEmotionalDepth(features);
                document.getElementById('emotionalDepth').innerHTML = `
                    <div style="font-size: 1.1rem; margin-bottom: 6px; color: var(--text-secondary);">Depth: ${depth.level}</div>
                    <div style="font-size: 0.8rem; opacity: 0.7;">${depth.description}</div>
                `;
                
                // Update synesthetic display
                this.updateSynestheticDisplay(emotion, features);
                
                // Update background colors - use vibrant colors if TV mode
                const isTVMode = document.body.classList.contains('tv-mode');
                const colors = isTVMode ? emotion.colorsVibrant : emotion.colors;
                this.updateBackgroundColors(colors);
                
                // Update particles
                this.updateParticles(emotion, features);
                
                // Store in history
                this.emotionalHistory.push({ emotion, features, timestamp: Date.now() });
                if (this.emotionalHistory.length > 100) {
                    this.emotionalHistory.shift();
                }
                
                // Save to Supabase if user is logged in
                if (window.authManager && window.authManager.currentUser) {
                    const trackName = document.getElementById('trackName').textContent;
                    
                    window.authManager.saveEmotionalMapping({
                        name: trackName !== 'No track loaded' ? trackName : 'Live Audio',
                        detectedEmotion: emotion.name,
                        confidence: emotion.confidence,
                        colors: emotion.colors,
                        features: features
                    });
                }
 // Broadcast to room if in one
if (window.authManager && window.authManager.currentRoomCode) {
    window.authManager.broadcastEmotionToRoom(emotion.name, emotion.colors);
}
            }

            calculateEmotionalDepth(features) {
                const complexity = (features.bass * 0.2 + features.mid * 0.3 + features.treble * 0.2 + 
                                  features.spectralCentroid * 0.3) / 255;
                
                if (complexity > 0.8) {
                    return { level: 'Profound', description: 'Multi-layered emotional complexity detected' };
                } else if (complexity > 0.6) {
                    return { level: 'Deep', description: 'Rich emotional texture with nuanced feelings' };
                } else if (complexity > 0.4) {
                    return { level: 'Moderate', description: 'Clear emotional expression with some depth' };
                } else {
                    return { level: 'Surface', description: 'Simple, direct emotional expression' };
                }
            }

            updateSynestheticDisplay(emotion, features) {
                const display = document.getElementById('synestheticDisplay');
                const colorIntensity = Math.round(features.energy * 100);
                const isTVMode = document.body.classList.contains('tv-mode');
                const colors = isTVMode ? emotion.colorsVibrant : emotion.colors;
                
                display.innerHTML = `
                    <div style="display: flex; gap: 8px; margin-bottom: 12px; justify-content: center;">
                        ${colors.map(color => `
                            <div style="width: 35px; height: 35px; background: ${color}; 
                                       border-radius: 8px; opacity: ${0.3 + features.energy * 0.7};
                                       box-shadow: 0 0 15px ${color}; transition: all 0.3s;"></div>
                        `).join('')}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-tertiary);">
                        <div>Primary: ${colors[0]}</div>
                        <div>Intensity: ${colorIntensity}%</div>
                        <div>Resonance: ${emotion.key}</div>
                    </div>
                `;
            }

            updateBackgroundColors(colors) {
                const bg = document.querySelector('.emotional-background');
                const opacity = document.body.classList.contains('tv-mode') ? '0.8' : '0.3';
                bg.style.background = `
                    radial-gradient(circle at 20% 50%, ${colors[0]}, transparent 40%),
                    radial-gradient(circle at 80% 80%, ${colors[1]}, transparent 40%),
                    radial-gradient(circle at 40% 20%, ${colors[2]}, transparent 40%)
                `;
                bg.style.opacity = opacity;
            }

            createParticles() {
                const container = document.getElementById('emotionParticles');
                container.innerHTML = ''; // Clear existing
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 10 + 's';
                    particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                    container.appendChild(particle);
                }
            }

            updateParticles(emotion, features) {
                const particles = document.querySelectorAll('.particle');
                const isTVMode = document.body.classList.contains('tv-mode');
                const colors = isTVMode ? emotion.colorsVibrant : emotion.colors;
                
                particles.forEach((particle, index) => {
                    const colorIndex = index % colors.length;
                    particle.style.background = colors[colorIndex];
                    particle.style.opacity = features.energy * (isTVMode ? 0.8 : 0.6);
                    particle.style.transform = `scale(${0.5 + features.energy * (isTVMode ? 1.5 : 1)})`;
                    particle.style.boxShadow = `0 0 ${6 + features.energy * 15}px ${colors[colorIndex]}`;
                });
            }

            togglePlayPause() {
                const audio = document.getElementById('audioElement');
                const btn = document.getElementById('playPauseBtn');
                
                if (audio.paused) {
                    audio.play();
                    btn.textContent = '⏸';
                } else {
                    audio.pause();
                    btn.textContent = '▶';
                }
            }

            seekTo(event) {
                const audio = document.getElementById('audioElement');
                const progressBar = document.getElementById('progressBar');
                const clickX = event.offsetX;
                const width = progressBar.offsetWidth;
                const duration = audio.duration;
                
                if (duration) {
                    audio.currentTime = (clickX / width) * duration;
                }
            }

            toggleLoop() {
                const btn = document.getElementById('loopBtn');
                const audio = document.getElementById('audioElement');
                
                this.isLooping = !this.isLooping;
                audio.loop = this.isLooping;
                
                if (this.isLooping) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }

            closePlayer() {
                const audioPlayer = document.getElementById('audioPlayer');
                const audio = document.getElementById('audioElement');
                
                // Stop audio
                audio.pause();
                audio.currentTime = 0;
                
                // Hide player
                audioPlayer.classList.remove('active');
                
                // Stop analysis if from file
                if (this.isAnalyzing && !this.source?.mediaStream) {
                    this.stopAnalysis();
                }
            }

            updateTimeDisplay() {
                const audio = document.getElementById('audioElement');
                const currentTime = document.getElementById('currentTime');
                const progressFill = document.getElementById('progressFill');
                
                if (audio.duration) {
                    currentTime.textContent = this.formatTime(audio.currentTime);
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressFill.style.width = progress + '%';
                }
            }

            formatTime(seconds) {
                if (!seconds || isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            toggleTVMode() {
                const btn = document.getElementById('tvModeBtn');
                const body = document.body;
                
                body.classList.toggle('tv-mode');
                btn.classList.toggle('active');
                
                // Save preference
                localStorage.setItem('tvMode', body.classList.contains('tv-mode'));
                
                // Update current colors if analyzing
                if (this.currentEmotion) {
                    const colors = body.classList.contains('tv-mode') ? 
                        this.currentEmotion.colorsVibrant : this.currentEmotion.colors;
                    this.updateBackgroundColors(colors);
                }
            }

            loadTVMode() {
                const tvMode = localStorage.getItem('tvMode') === 'true';
                if (tvMode) {
                    document.body.classList.add('tv-mode');
                    document.getElementById('tvModeBtn').classList.add('active');
                }
            }

            stopAnalysis() {
            this.isAnalyzing = false;
    
            if (this.source) {
                // Properly disconnect and stop everything
                try {
                    if (this.source.mediaStream) {
                        // Stop all tracks
                        this.source.mediaStream.getTracks().forEach(track => {
                            track.stop();
                        });
                    }
                    if (this.source.disconnect) {
                        this.source.disconnect();
                    }
                } catch (e) {
                    console.error('Error stopping analysis:', e);
                    }
                }
    
             // Clear references
             this.source = null;
             this.analyser = null;
    
             this.updateStatus('Ready to Feel Music', false);
             }

            updateStatus(text, active) {
                document.getElementById('statusText').textContent = text;
                const indicator = document.getElementById('statusIndicator');
                if (active) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            }
        }

        // Initialize the engine when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const engine = new EmotionalIntelligenceEngine();
        });
    </script>
</body>
</html>